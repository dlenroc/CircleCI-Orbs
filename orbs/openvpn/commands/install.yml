description: >
  Install OpenVPN client

parameters:
  cache-version:
    default: v1
    type: string
  when:
    default: on_success
    type: enum
    enum: [always, on_fail, on_success]

steps:
  - restore_cache:
      name: Restore OpenVPN package
      key: openvpn-{{ arch }}-<< parameters.cache-version >>

  - run:
      name: Install OpenVPN
      when: << parameters.when >>
      command: |
        package=/tmp/openvpn

        if [ ! -d "${package}" ]; then
          mkdir -p "${package}"
          sudo apt-get update
          sudo apt-get install -d -o=dir::cache="${package}" \
            openvpn \
            oathtool \
            net-tools
        fi

        sudo dpkg -R -i "${package}"

  - save_cache:
      name: Cache OpenVPN package
      key: openvpn-{{ arch }}-<< parameters.cache-version >>
      paths:
        - /tmp/openvpn/archives
